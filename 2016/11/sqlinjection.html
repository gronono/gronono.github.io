<!DOCTYPE html> <html> <head lang="fr"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Gronono | SQL Injection </title> <meta name="description" content="En début de semaine, j’ai eu des rappels sur les failles de sécurité liée au code et notamment le fameux SQL Injection."> <link rel="stylesheet" href="/assets/main.css"> <link rel="canonical" href="http://gronono.github.io/2016/11/sqlinjection"> <link rel="alternate" type="application/rss+xml" title="Gronono" href="http://gronono.github.io/feed.xml"/> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/brands.css" integrity="sha384-i2PyM6FMpVnxjRPi0KW/xIS7hkeSznkllv+Hx/MtYDaHA5VcF0yL3KVlvzp8bWjQ" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/regular.css" integrity="sha384-hCIN6p9+1T+YkCd3wWjB5yufpReULIPQ21XA/ncf3oZ631q2HEhdC7JgKqbk//4+" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/solid.css" integrity="sha384-ioUrHig76ITq4aEJ67dHzTvqjsAP/7IzgwE7lgJcg2r7BRNGYSK0LwSmROzYtgzs" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/fontawesome.css" integrity="sha384-sri+NftO+0hcisDKgr287Y/1LVnInHJ1l+XC7+FOabmTTIK0HnE2ID+xxvJ21c5J" crossorigin="anonymous"> </head> <body> <div class="header-placeholder"></div> <header class="header"> <div class="wrapper"> <div id="sidebar-toggle">TOC</div> <a class="site-title" href="/">Gronono</a> <nav class="site-nav"> <a class="page-link" href="/">Articles</a> <a class="page-link" href="/archives">Archives</a> <a class="page-link" href="/about">À propos</a> </nav> </div> </header> <div class="page-content"> <div class="wrapper"> <div class="col-main"> <div class="post"> <header class="post-header"> <h1 class="post-title">SQL Injection</h1> <div class="post-meta"> <span class="date"><i class="far fa-calendar-alt"></i> 30 novembre 2016</span> <span class="tags"><i class="fas fa-tags"></i> <a href="/tags/java">java</a> , <a href="/tags/spring">spring</a> , <a href="/tags/sql">sql</a> </span> </div> </header> <article class="post-content"> <p>En début de semaine, j’ai eu des rappels sur les failles de sécurité liée au code et notamment le fameux <a href="https://fr.wikipedia.org/wiki/Injection_SQL" rel="nofollow noopener">SQL Injection</a>.</p> <p>Une des erreurs classiques est de faire de la concaténation de chaines sans considérer le contenu des paramètres. Exemple la requête suivante (en HQL): <code class="language-plaintext highlighter-rouge">"from Person where name ='" + input + "'"</code> peut être interprété comme <code class="language-plaintext highlighter-rouge">"from Person where name = '' or '1'='1'"</code> si <code class="language-plaintext highlighter-rouge">input = ' or '1'='1</code>. Et donc au lieu de selectionner les personnes en filtrant sur le nom, on retourne l’ensemble des personnes.</p> <p>Au taf, on utilise <code class="language-plaintext highlighter-rouge">spring-data-jpa</code>. Du coup je me suis demandé si les développeurs de Spring avaient pris la problématique en considération.</p> <h2 id="tests">Tests</h2> <p>J’ai testé:</p> <ol> <li>la concaténation (expliquée ci-dessus) en utilisant <code class="language-plaintext highlighter-rouge">EntityManager</code> </li> <li>toujours dans l’<code class="language-plaintext highlighter-rouge">EntityManager</code>, le passage par les Bind Parameters</li> <li>la génération automatique des requêtes avec <code class="language-plaintext highlighter-rouge">spring-data-jpa</code> </li> <li>l’écriture des requêtes avec <code class="language-plaintext highlighter-rouge">@Query</code> </li> </ol> <h3 id="concaténation-avec-lentitymanager">Concaténation avec l’<code class="language-plaintext highlighter-rouge">EntityManager</code> </h3> <p>Voici le code de la méthode:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Person where name = '"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre></figure> <p>Et sans surprise, on tombe dans le cas décrit en introduction. Notre code est vulnérable aux injections SQL. <em>À ne pas faire</em>.</p> <h3 id="bind-parameters-sur-lentitymanager">Bind Parameters sur l’<code class="language-plaintext highlighter-rouge">EntityManager</code> </h3> <p>Dans ce cas, on injecte le paramètre de la requête en utilisant la méthode <code class="language-plaintext highlighter-rouge">setParameter(String, Object)</code>:</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from Person where name = :name"</span><span class="o">);</span>
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span></code></pre></figure> <p>JPA semble bien faire son travail et traite les paramètres pour éviter l’injection SQL. Si on passe par l’<code class="language-plaintext highlighter-rouge">EntityManager</code>, c’est la méthode recommandée.</p> <h3 id="spring-data-jpa">Spring Data JPA</h3> <p>Ici, on utilise le mécanisme un peu magique de <a href="http://docs.spring.io/spring-data/jpa/docs/current/reference/html/" rel="nofollow noopener">Spring Data JPA</a> se basant sur le nom de la méthode pour générer la requête :</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure> <p>Sans surprise, les équipes de Spring ne sont pas tombés dans le panneau.</p> <h3 id="query">@Query</h3> <p>Dans ce cas, on utilise toujours Spring Data JPA, mais on écrit nous-mêmes la requête avec l’annotation <code class="language-plaintext highlighter-rouge">@Query</code> :</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Query</span><span class="o">(</span><span class="s">"from Person where name = :name"</span><span class="o">)</span>
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure> <p>Et encore une fois, il n’y a pas de problème d’injection.</p> <h2 id="conclusion">Conclusion</h2> <p>Il ne faut jamais faire de la concaténation de chaine lors de la génération de requêtes SQL. Il est plus simple et plus sûr d’utiliser des mécanismes proposés par les frameworks et librairies.</p> <p><a href="https://github.com/gronono/gronono.github.io/blob/master/demo/sql-injection" rel="nofollow noopener">Les sources des tests sont disponibles sur github</a>.</p> </article> <div class="post-comments"> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="gronono";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow noopener">comments powered by Disqus.</a> </noscript> </div> </div> </div> <div class="col-second"> <div class="col-box col-box-author"> <img class="avatar" src="/assets/profile.jpg" alt="Arnaud Brunet"> <div class="col-box-title name"> <a href="/about">Arnaud Brunet</a> </div> <blockquote> <p><q>La connaissance s'acquiert par l'expérience, tout le reste n'est que de l'information.</q></p> <footer>Albert Einstein</footer> </blockquote> <ul class="contact"> <li> <a title="GitHub" href="https://github.com/gronono" target="_blank"> <i class="fab fa-github"></i> </a> </li> <li> <a title="Stack Overflow" href="https://stackoverflow.com/users/2909535/arnaud" target="_blank"> <i class="fab fa-stack-overflow"></i> </a> </li> <li> <a title="RSS" href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a> </li> </ul> </div> <div class="col-box"> <div class="col-box-title">Articles récents</div> <ul class="post-list"> <li><a class="post-link" href="/2020/08/virtualbox-routeur">Créer une infra virtuelle avec VirtualBox - Partie 1 : le routeur Internet</a></li> <li><a class="post-link" href="/2019/05/docker-proxy-cache">Installer un proxy-cache pour Docker en 2 minutes</a></li> <li><a class="post-link" href="/2019/05/create-jks-from-p7b">Générer un fichier JKS à partir d'une clé privée et d'un fichier P7B</a></li> <li><a class="post-link" href="/2019/05/ohmyzsh_lxc">Auto-complétion de LXC avec Oh-My-Zsh</a></li> <li><a class="post-link" href="/2019/05/apache-loadbalancer">Configurer Apache en mode load balancer</a></li> <li><a class="post-link" href="/2019/05/lxc-expose-port">Exposer un service tournant dans un container LXC</a></li> <li><a class="post-link" href="/2019/05/jekyll">Reprise du blog</a></li> <li><a class="post-link" href="/2016/11/sqlinjection">SQL Injection</a></li> <li><a class="post-link" href="/2016/11/hibernateutils">HibernateUtils</a></li> <li><a class="post-link" href="/2016/05/install-pxe-server">Installer un serveur PXE</a></li> </ul> </div> <div class="col-box"> <div class="col-box-title">Nuage de tags</div> <a href="/tags/java" class="tag tag-3">java</code></a> <a href="/tags/spring" class="tag tag-2">spring</code></a> <a href="/tags/lxc" class="tag tag-2">lxc</code></a> <a href="/tags/linux" class="tag tag-2">linux</code></a> <a href="/tags/virtualbox" class="tag tag-1">virtualbox</code></a> <a href="/tags/tftp" class="tag tag-1">tftp</code></a> <a href="/tags/sql" class="tag tag-1">sql</code></a> <a href="/tags/réseau" class="tag tag-1">réseau</code></a> <a href="/tags/routeur" class="tag tag-1">routeur</code></a> <a href="/tags/pxe" class="tag tag-1">pxe</code></a> <a href="/tags/oh-my-zsh" class="tag tag-1">oh-my-zsh</code></a> <a href="/tags/loadbalancer" class="tag tag-1">loadbalancer</code></a> <a href="/tags/jekyll" class="tag tag-1">jekyll</code></a> <a href="/tags/hibernate" class="tag tag-1">hibernate</code></a> <a href="/tags/docker" class="tag tag-1">docker</code></a> <a href="/tags/dhcp" class="tag tag-1">dhcp</code></a> <a href="/tags/debian" class="tag tag-1">debian</code></a> <a href="/tags/architecture" class="tag tag-1">architecture</code></a> <a href="/tags/apache" class="tag tag-1">apache</code></a> </div> <div class="col-box post-toc hide"> <div class="col-box-title">Sommaire</div> </div> </div> </div> </div> <footer class="footer"> <div class="wrapper"> <a href="/about">&copy; 2020 Arnaud Brunet</a> </div> </footer> <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script> <script src="/assets/easybook.js"></script> </body> </html>