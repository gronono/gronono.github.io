<!DOCTYPE html> <html> <head lang="fr"> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Gronono | Créer une infra virtuelle avec VirtualBox - Partie 1 : le routeur Internet </title> <meta name="description" content="Voici le premier article d’une série sur comment créer une infrastructure virtuelle sous VirtualBox.Dans cet article, nous allons voir comment simuler un rés..."> <link rel="stylesheet" href="/assets/main.css"> <link rel="canonical" href="http://gronono.github.io/2020/08/virtualbox-routeur"> <link rel="alternate" type="application/rss+xml" title="Gronono" href="http://gronono.github.io/feed.xml"/> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/brands.css" integrity="sha384-i2PyM6FMpVnxjRPi0KW/xIS7hkeSznkllv+Hx/MtYDaHA5VcF0yL3KVlvzp8bWjQ" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/regular.css" integrity="sha384-hCIN6p9+1T+YkCd3wWjB5yufpReULIPQ21XA/ncf3oZ631q2HEhdC7JgKqbk//4+" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/solid.css" integrity="sha384-ioUrHig76ITq4aEJ67dHzTvqjsAP/7IzgwE7lgJcg2r7BRNGYSK0LwSmROzYtgzs" crossorigin="anonymous"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/fontawesome.css" integrity="sha384-sri+NftO+0hcisDKgr287Y/1LVnInHJ1l+XC7+FOabmTTIK0HnE2ID+xxvJ21c5J" crossorigin="anonymous"> </head> <body> <div class="header-placeholder"></div> <header class="header"> <div class="wrapper"> <div id="sidebar-toggle">TOC</div> <a class="site-title" href="/">Gronono</a> <nav class="site-nav"> <a class="page-link" href="/">Articles</a> <a class="page-link" href="/archives">Archives</a> <a class="page-link" href="/about">À propos</a> </nav> </div> </header> <div class="page-content"> <div class="wrapper"> <div class="col-main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Créer une infra virtuelle avec VirtualBox - Partie 1 : le routeur Internet</h1> <div class="post-meta"> <span class="date"><i class="far fa-calendar-alt"></i> 31 août 2020</span> <span class="tags"><i class="fas fa-tags"></i> <a href="/tags/debian">debian</a> , <a href="/tags/linux">linux</a> , <a href="/tags/virtualbox">virtualbox</a> , <a href="/tags/routeur">routeur</a> , <a href="/tags/r%C3%A9seau">réseau</a> </span> </div> </header> <article class="post-content"> <p>Voici le premier article d’une série sur comment créer une infrastructure virtuelle sous VirtualBox.</p> <p>Dans cet article, nous allons voir comment simuler un réseau local/privé ayant accès à Internet dans VirtualBox.</p> <p>Le but est d’arriver à mettre en place le réseau privé définit par le schéma suivant :</p> <p><img src="/assets/virtual-router/virtualbox-router.png" alt="Schéma du réseau"></p> <p>Au total, on a trois machines virtuelles :</p> <ul> <li>les machines nommées <code class="language-plaintext highlighter-rouge">machine1</code> et <code class="language-plaintext highlighter-rouge">machine2</code> possèdent chacune une seule interface réseau sur le réseau interne à VirtualBox nommé <code class="language-plaintext highlighter-rouge">intnet</code>,</li> <li>la machine nommée <code class="language-plaintext highlighter-rouge">routeur</code> possède deux interfaces réseaux : une sur le réseau interne <code class="language-plaintext highlighter-rouge">intnet</code> et l’autre configurée en NAT.</li> </ul> <p>L’accès à Internet depuis les machines ‘machine1’ et ‘machine2’ se fait via la machine ‘routeur’.</p> <p>Pour les trois machines, je suis parti d’une base Debian 10.</p> <h1 id="configuration-de-la-machine-routeur">Configuration de la machine ‘routeur’</h1> <p>Il s’agit de l’installation la plus compliquée puisqu’elle sert de routeur réseau entre le réseau NAT et le réseau interne.</p> <p>Dans VirtualBox, j’ai configuré les deux interfaces comme indiqué sur les captures d’écran suivantes :</p> <p><img src="/assets/virtual-router/virtualbox-nat.png" alt="Configuration du NAT"></p> <p><img src="/assets/virtual-router/virtualbox-intnet.png" alt="Configuration du réseau interne"></p> <p>La commande <code class="language-plaintext highlighter-rouge">ip address show</code> nous montre bien qu’on a deux interfaces dont l’une d’elles (enp0s3) possède une IP (10.0.2.15/24). Il s’agit de l’interface en mode NAT. VirtualBox lui attribue automatiquement une adresse.</p> <p>Par contre la seconde interface (enp0s8) n’est pas configurée.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip address show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    <span class="nb">link</span>/ether 08:00:27:89:4b:81 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
       valid_lft 84902sec preferred_lft 84902sec
    inet6 fe80::a00:27ff:fe89:4b81/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
3: enp0s8: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 08:00:27:a1:c2:6e brd ff:ff:ff:ff:ff:ff
</code></pre></div></div> <p>Pour la configurer, nous allons lui fixer son adresse en ajoutant le fichier <code class="language-plaintext highlighter-rouge">/etc/network/interfaces.d/enp0s8</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/network/interfaces/enp0s8
auto enp0s8
iface enp0s8 inet static
  address 192.168.2.1
  netmask 255.255.255.0
  network 192.168.2.0
  broadcast 192.168.2.255
</code></pre></div></div> <blockquote> <p>Après l’activation de la nouvelle interface, la connexion SSH freezait après avoir entré le mot de passe. Pour y remédier, j’ai dû désactiver l’option <code class="language-plaintext highlighter-rouge">UseDNS</code> dans la configuration du daemon SSH.</p> </blockquote> <p>Après un reboot de la machine, on peut voir que notre interface possède maintenant une adresse IP:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip address show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    <span class="nb">link</span>/ether 08:00:27:89:4b:81 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
       valid_lft 86381sec preferred_lft 86381sec
    inet6 fe80::a00:27ff:fe89:4b81/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
3: enp0s8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    <span class="nb">link</span>/ether 08:00:27:a1:c2:6e brd ff:ff:ff:ff:ff:ff
    inet 192.168.2.1/24 brd 192.168.2.255 scope global enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fea1:c26e/64 scope <span class="nb">link 
       </span>valid_lft forever preferred_lft forever
</code></pre></div></div> <p>Et on a toujours accès à Internet</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ping <span class="nt">-c1</span> gronono.fr
PING gronono.fr <span class="o">(</span>185.199.109.153<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 185.199.109.153 <span class="o">(</span>185.199.109.153<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>282 ms

<span class="nt">---</span> gronono.fr ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 281.546/281.546/281.546/0.000 ms
</code></pre></div></div> <p>Il est temps maintenant d’activer le routage.</p> <p>Pour cela, il faut dans un premier temps activer l’<code class="language-plaintext highlighter-rouge">IP Forward</code> au niveau du noyau en supprimant le <code class="language-plaintext highlighter-rouge">#</code> sur la ligne correspondante le fichier <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> <span class="s2">"ip_forward"</span> /etc/sysctl.conf 
net.ipv4.ip_forward<span class="o">=</span>1
</code></pre></div></div> <p>Puis il faut créer une règle <code class="language-plaintext highlighter-rouge">iptables</code> pour faire du NAT entre les deux interfaces réseaux en créant le script executable <code class="language-plaintext highlighter-rouge">/etc/if-pre-up.d/iptables</code> :</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/network/if-pre-up.d/iptables 
<span class="c">#!/bin/sh</span>
/usr/sbin/iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> enp0s3 <span class="nt">-j</span> MASQUERADE
/usr/sbin/iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> enp0s8 <span class="nt">-j</span> ACCEPT

<span class="nv">$ </span><span class="nb">sudo chmod</span> +x /etc/network/if-pre-up.d/iptables
</code></pre></div></div> <p>On reboote la machine et on peut passer à la configuration des deux autres machines.</p> <h1 id="configuration-des-machines-machine1-et-machine2">Configuration des machines “machine1” et “machine2”</h1> <p>La configuration des machines est strictement identique au détail de l’adresse IP près.</p> <p>Dans VirtualBox, on commence par configurer la première interface en mode réseau internet en prenant soin de bien mettre le même nom de réseau que l’interface du serveur.</p> <p><img src="/assets/virtual-router/virtualbox-machine-intnet.png" alt="Configuration du réseau internet"></p> <p>On vérifie que notre interface n’a pas d’adresse IP:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ip address show
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: enp0s3: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 08:00:27:5e:7d:50 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::a00:27ff:fe5e:7d50/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
</code></pre></div></div> <p>On va maintenant lui attribuer l’IP fixe 192.168.2.101/24 (la machine2 aura l’IP 192.168.2.102/24) en ajoutant le fichier <code class="language-plaintext highlighter-rouge">/etc/network/interfaces.d/enp0s3</code> :</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/network/interfaces.d/enp0s3
auto enp0s3
iface enp0s3 inet static
  address 192.168.2.101
  netmask 255.255.255.0
  network 192.168.2.0
  broadcast 192.168.2.255
</code></pre></div></div> <p>Après un reboot, nos deux machines (<code class="language-plaintext highlighter-rouge">routeur</code> et <code class="language-plaintext highlighter-rouge">machine1</code>) peuvent se pinguer respectivement mais la <code class="language-plaintext highlighter-rouge">machine1</code> ne résout pas les noms DNS:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ping gronono.fr
ping: gronono.fr: Échec temporaire dans la résolution <span class="nb">du </span>nom
</code></pre></div></div> <p>Pour y remédier, il faut ajouter une gateway :</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> /etc/network/interfaces.d/enp0s3
auto enp0s3
iface enp0s3 inet static
  address 192.168.2.101
  netmask 255.255.255.0
  network 192.168.2.0
  broadcast 192.168.2.255
  gateway 192.168.2.1
</code></pre></div></div> <p>Après un petit reboot, notre <code class="language-plaintext highlighter-rouge">machine1</code> devrait maintenant pouvoir accéder à Internet:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ $ </span>ping <span class="nt">-c1</span> gronono.fr
PING gronono.fr <span class="o">(</span>185.199.110.153<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 185.199.110.153 <span class="o">(</span>185.199.110.153<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>61 <span class="nb">time</span><span class="o">=</span>203 ms

<span class="nt">---</span> gronono.fr ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 203.029/203.029/203.029/0.000 ms
</code></pre></div></div> <blockquote> <p>Si vous avez toujours un problème de résolution de nom, il se peut que votre configuration DNS ne soit pas bonne. Vérifiez le fichier <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> et en cas de doute, vous pouvez utiliser le serveur DNS de Google : <code class="language-plaintext highlighter-rouge">8.8.8.8</code> (après avoir vérifié que vous arrivez à faire un ping dessus.)</p> </blockquote> <p>Il reste à faire la même chose pour les autres machines de notre réseau.</p> <h1 id="conclusion">Conclusion</h1> <p>Dans cette première partie, nous avons mis en place la base de notre infrastructure.</p> <p>Nous verrons dans un prochain article comment mettre en place un serveur DHCP pour nos machines <code class="language-plaintext highlighter-rouge">machine1</code> et <code class="language-plaintext highlighter-rouge">machine2</code>.</p> </article> <div class="post-comments"> <div id="disqus_thread"></div> <script type="text/javascript">var disqus_shortname="gronono";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow noopener">comments powered by Disqus.</a> </noscript> </div> </div> </div> <div class="col-second"> <div class="col-box col-box-author"> <img class="avatar" src="/assets/profile.jpg" alt="Arnaud Brunet"> <div class="col-box-title name"> <a href="/about">Arnaud Brunet</a> </div> <blockquote> <p><q>La connaissance s'acquiert par l'expérience, tout le reste n'est que de l'information.</q></p> <footer>Albert Einstein</footer> </blockquote> <ul class="contact"> <li> <a title="GitHub" href="https://github.com/gronono" target="_blank"> <i class="fab fa-github"></i> </a> </li> <li> <a title="Stack Overflow" href="https://stackoverflow.com/users/2909535/arnaud" target="_blank"> <i class="fab fa-stack-overflow"></i> </a> </li> <li> <a title="RSS" href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a> </li> </ul> </div> <div class="col-box"> <div class="col-box-title">Articles récents</div> <ul class="post-list"> <li><a class="post-link" href="/2020/08/virtualbox-routeur">Créer une infra virtuelle avec VirtualBox - Partie 1 : le routeur Internet</a></li> <li><a class="post-link" href="/2019/05/docker-proxy-cache">Installer un proxy-cache pour Docker en 2 minutes</a></li> <li><a class="post-link" href="/2019/05/create-jks-from-p7b">Générer un fichier JKS à partir d'une clé privée et d'un fichier P7B</a></li> <li><a class="post-link" href="/2019/05/ohmyzsh_lxc">Auto-complétion de LXC avec Oh-My-Zsh</a></li> <li><a class="post-link" href="/2019/05/apache-loadbalancer">Configurer Apache en mode load balancer</a></li> <li><a class="post-link" href="/2019/05/lxc-expose-port">Exposer un service tournant dans un container LXC</a></li> <li><a class="post-link" href="/2019/05/jekyll">Reprise du blog</a></li> <li><a class="post-link" href="/2016/11/sqlinjection">SQL Injection</a></li> <li><a class="post-link" href="/2016/11/hibernateutils">HibernateUtils</a></li> <li><a class="post-link" href="/2016/05/install-pxe-server">Installer un serveur PXE</a></li> </ul> </div> <div class="col-box"> <div class="col-box-title">Nuage de tags</div> <a href="/tags/java" class="tag tag-3">java</code></a> <a href="/tags/spring" class="tag tag-2">spring</code></a> <a href="/tags/lxc" class="tag tag-2">lxc</code></a> <a href="/tags/linux" class="tag tag-2">linux</code></a> <a href="/tags/virtualbox" class="tag tag-1">virtualbox</code></a> <a href="/tags/tftp" class="tag tag-1">tftp</code></a> <a href="/tags/sql" class="tag tag-1">sql</code></a> <a href="/tags/réseau" class="tag tag-1">réseau</code></a> <a href="/tags/routeur" class="tag tag-1">routeur</code></a> <a href="/tags/pxe" class="tag tag-1">pxe</code></a> <a href="/tags/oh-my-zsh" class="tag tag-1">oh-my-zsh</code></a> <a href="/tags/loadbalancer" class="tag tag-1">loadbalancer</code></a> <a href="/tags/jekyll" class="tag tag-1">jekyll</code></a> <a href="/tags/hibernate" class="tag tag-1">hibernate</code></a> <a href="/tags/docker" class="tag tag-1">docker</code></a> <a href="/tags/dhcp" class="tag tag-1">dhcp</code></a> <a href="/tags/debian" class="tag tag-1">debian</code></a> <a href="/tags/architecture" class="tag tag-1">architecture</code></a> <a href="/tags/apache" class="tag tag-1">apache</code></a> </div> <div class="col-box post-toc hide"> <div class="col-box-title">Sommaire</div> </div> </div> </div> </div> <footer class="footer"> <div class="wrapper"> <a href="/about">&copy; 2020 Arnaud Brunet</a> </div> </footer> <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$']]}});</script> <script src="/assets/easybook.js"></script> </body> </html>